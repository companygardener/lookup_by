#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require "combustion"

Combustion.initialize! :active_record

require "benchmark/ips"

# --- Seed data ----------------------------------------------------------------

puts "Seeding benchmark data..."

%w[Portland Seattle Denver Austin Chicago Miami Boston].each do |name|
  City.find_or_create_by!(city: name)
end

%w[OR WA CO TX IL FL MA].each do |name|
  State.find_or_create_by!(state: name)
end

(97000..98000).each do |code|
  PostalCode.find_or_create_by!(postal_code: code)
end

puts "done\n\n"

# --- Benchmark ----------------------------------------------------------------

Benchmark.ips do |x|
  x.config(warmup: 2, time: 5)

  x.report("(no cache)          ") do
    City["Portland"]
  end

  hot_zips  = (97000..97009).map(&:to_s)
  cold_zips = (97010..98000).map(&:to_s)

  x.report("(LRU cache, 50% hot)") do
    code = rand < 0.5 ? hot_zips.sample : cold_zips.sample
    PostalCode[code]
  end

  x.report("(LRU cache, 90% hot)") do
    code = rand < 0.9 ? hot_zips.sample : cold_zips.sample
    PostalCode[code]
  end

  x.report("(LRU cache, 95% hot)") do
    code = rand < 0.95 ? hot_zips.sample : cold_zips.sample
    PostalCode[code]
  end

  x.report("(LRU cache, 99% hot)") do
    code = rand < 0.99 ? hot_zips.sample : cold_zips.sample
    PostalCode[code]
  end

  x.report("(full cache)        ") do
    State["OR"]
  end

  x.compare!
end
